<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Superliga - BR da Depressão</title>
    <link rel="icon" href="./bdd.png" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* Tema Dark (padrão) */
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-tertiary: #64748b;
            --accent-primary: #3b82f6; /* Azul: Top 4 */
            --accent-secondary: #8b5cf6;
            --accent-success: #10b981; /* Verde: Top 12 */
            --accent-warning: #f59e0b;
            --accent-danger: #ef4444; /* Vermelho: Z4 */
            --border-color: #334155;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            
            /* Transições */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Tema Light */
        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-card: #ffffff;
            --bg-input: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-tertiary: #94a3b8;
            --accent-primary: #2563eb;
            --accent-secondary: #7c3aed;
            --accent-success: #059669;
            --accent-danger: #dc2626;
            --border-color: #e2e8f0;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

       * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-size: 16px; }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-primary); 
            color: var(--text-primary); 
            min-height: 100vh;
            transition: background-color var(--transition-base);
        }
        .container { max-width: 900px; margin: 0 auto; padding: 0 1rem; }

        /* Header simplificado */
        .app-header {
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-primary);
            text-decoration: none;
            display: flex;
            align-items: center;
        }
        .logo span {
            color: var(--accent-secondary);
        }
        .header-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }
        .btn-icon {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            border: none;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }
        .btn-icon:hover {
            background: var(--accent-primary);
            color: white;
            transform: translateY(-2px);
        }
        
        /* CABEÇALHO E ABAS */
        .header-title { 
            font-size: 24px; 
            font-weight: 700; 
            margin-bottom: 30px; 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            color: var(--text-primary); 
        }
        .tabs { 
            display: flex; 
            margin-bottom: 30px; 
            background-color: var(--bg-secondary); 
            border-radius: 0.75rem; 
            padding: 4px; 
            border: 1px solid var(--border-color); 
        }
        .tab { 
            padding: 8px 16px; 
            cursor: pointer; 
            border-radius: 6px; 
            font-weight: 500; 
            transition: all 0.2s ease; 
            text-align: center; 
            flex: 1; 
            border: none; 
            background: none; 
            color: var(--text-secondary); 
        }
        .tab.active { 
            background-color: var(--accent-primary); 
            color: white; 
            box-shadow: var(--shadow-sm);
        }

        /* TABELA DE CLASSIFICAÇÃO */
        .standings-container {
            background: var(--bg-card);
            border-radius: 1rem;
            border: 1px solid var(--border-color);
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }
        .standings-table {
            width: 100%;
            border-collapse: collapse;
        }
        .standings-table thead {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }
        .standings-table th {
            text-align: left;
            padding: 1rem 1.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }
        .standings-table td {
            padding: 0.75rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.95rem;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .standings-table tr:last-child td { border-bottom: none; }
        .standings-table tbody tr:hover { background: var(--bg-secondary); }

        /* Estilo da linha do jogador */
        .player-cell {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .player-logo {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: contain;
        }
        .player-name {
            font-weight: 500;
        }
        .points-col {
            font-weight: 700;
            color: var(--accent-primary);
        }
        .round-points-col {
             font-size: 0.75rem;
             font-weight: 600;
             color: var(--accent-success);
             white-space: nowrap;
        }

        /* Cores de Classificação (Linhas laterais) */
        .standings-row {
            border-left: 4px solid transparent;
            position: relative;
        }
        .standings-row.top-4 { /* Libertadores/Champions */
            border-left-color: var(--accent-primary);
        }
        .standings-row.mid-table { /* Sul-Americana/Vaga de Copa */
            border-left-color: var(--accent-success);
        }
        .standings-row.z4 { /* Rebaixamento */
            border-left-color: var(--accent-danger);
            background: rgba(239, 68, 68, 0.05); /* Fundo levemente avermelhado */
        }
        .standings-row.current-user-row {
            background: rgba(59, 130, 246, 0.1);
        }
        .standings-row.current-user-row:hover {
            background: rgba(59, 130, 246, 0.2);
        }

        /* NOVO: PÓDIO */
        .podium-container { display: flex; justify-content: center; align-items: flex-end; gap: 15px; margin-bottom: 40px; min-height: 220px; }
        .podium-card {
            background: linear-gradient(145deg, var(--card-bg-light), var(--card-bg-color));
            border-radius: var(--border-radius); padding: 20px; text-align: center;
            border: 1px solid var(--border-color); width: 28%; position: relative;
            animation: slideUp 0.5s ease-out backwards;
        }
        .podium-card .logo { width: 70px; height: 70px; border-radius: 50%; object-fit: contain; margin-bottom: 10px; border: 3px solid #fff; }
        .podium-card .name { font-weight: 600; font-size: 1.1em; }
        .podium-card .points { font-size: 1.5em; font-weight: 800; margin-top: 5px; }
        .podium-card .position-badge {
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
            width: 40px; height: 40px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; font-size: 1.2em; font-weight: 700; color: #111;
        }
        .podium-card.pos-1 { width: 32%; padding-top: 30px; border-color: var(--gold); box-shadow: 0 0 25px rgba(255, 193, 7, 0.3); }
        .podium-card.pos-1 .position-badge { background-color: var(--gold); }
        .podium-card.pos-1 .logo { width: 80px; height: 80px; border-color: var(--gold); }
        .podium-card.pos-2 { border-color: var(--silver); box-shadow: 0 0 20px rgba(192, 192, 192, 0.2); }
        .podium-card.pos-2 .position-badge { background-color: var(--silver); }
        .podium-card.pos-3 { border-color: var(--bronze); box-shadow: 0 0 20px rgba(205, 127, 50, 0.2); }
        .podium-card.pos-3 .position-badge { background-color: var(--bronze); }

        /* LISTA DE CLASSIFICAÇÃO */
        .standings-header { font-size: 22px; font-weight: 600; margin-bottom: 20px; }
        .standings-list { list-style: none; display: flex; flex-direction: column; gap: 12px; }
        .player-card {
            display: flex; align-items: center; background-color: var(--card-bg-color); padding: 12px 15px;
            border-radius: var(--border-radius); border: 1px solid var(--border-color);
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
            cursor: pointer; position: relative; animation: fadeIn 0.5s ease-out backwards;
        }
        .player-card:hover { transform: scale(1.02); box-shadow: 0 0 15px var(--primary-glow); border-color: var(--primary-color); }
        .player-card.current-user-row { border-color: var(--primary-color); background: linear-gradient(90deg, rgba(0,123,255,0.1), transparent); }
        
        .player-card .pos { font-weight: 700; font-size: 16px; color: var(--text-color-light); width: 40px; text-align: center; }
        .player-card .logo { width: 32px; height: 32px; object-fit: contain; margin: 0 10px; }
        .player-card .name { font-weight: 600; font-size: 16px; flex-grow: 1; display: flex; align-items: center; gap: 8px; }
        .player-card .points-info { text-align: right; }
        .player-card .total-points { font-size: 18px; font-weight: 700; }
        .player-card .round-points { font-size: 14px; color: #28a745; font-weight: 600; }
        .hot-streak-icon { color: #ff6a00; }
        .current-user-badge { font-size: 10px; background-color: var(--primary-color); color: #fff; padding: 3px 8px; border-radius: 20px; font-weight: 600; }

        /* FAIXAS DE CLASSIFICAÇÃO */
        .player-card::before {
            content: ''; position: absolute; left: 0; top: 0;
            width: 6px; height: 100%; background-color: transparent; border-radius: 12px 0 0 12px;
        }
        .position-1::before, .position-2::before, .position-3::before, .position-4::before { background-color: #007bff; }
        .position-18::before, .position-19::before, .position-20::before, .position-21::before, .position-22::before, .position-23::before { background-color: #dc3545; }
        .legend { display: flex; gap: 20px; margin-top: 20px; font-size: 14px; }
        .legend-item { display: flex; align-items: center; gap: 8px; }
        .legend-color { width: 14px; height: 14px; border-radius: 3px; }

        dialog {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            border: 1px solid var(--border-color);
            border-radius: 16px; /* Mais arredondado */
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
            width: 90%; max-width: 600px;
            padding: 0; margin: 0;
            background: linear-gradient(160deg, var(--card-bg-light), var(--card-bg-color));
            color: var(--text-color);
            animation: fadeIn 0.3s ease-out, slideUp 0.3s ease-out;
        }
        dialog::backdrop {
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }
        dialog[open] {
            display: flex;
            flex-direction: column;
        }

        /* --- Cabeçalho --- */
        .dialog-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            background-color: rgba(0,0,0,0.1); /* Fundo sutil */
        }
        .dialog-header h3 {
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .dialog-header .close-btn {
            background: none; border: none; font-size: 28px;
            cursor: pointer; color: var(--text-color-light);
            width: 40px; height: 40px; border-radius: 50%;
            transition: background-color 0.2s, color 0.2s;
        }
        .dialog-header .close-btn:hover {
            background-color: var(--card-bg-light);
            color: #fff;
        }

        /* --- Corpo do Dialog --- */
        .dialog-body {
            padding: 24px;
            overflow-y: auto;
        }

        /* --- Sumário do Jogador --- */
        .player-summary {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border-color);
        }
        .player-summary .logo {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 3px solid var(--primary-color);
            box-shadow: 0 0 15px var(--primary-glow);
        }
        .player-summary .info .name {
            font-size: 26px;
            font-weight: 700;
            color: #fff;
        }
        .player-summary .info .team {
            font-size: 16px;
            color: var(--text-color-light);
        }

        /* --- Cards de Estatísticas --- */
        .player-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            text-align: left; /* Alinhado à esquerda para melhor leitura */
            margin-bottom: 24px;
        }
        .stat-item {
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
        }
        .stat-item .value {
            font-size: 28px;
            font-weight: 800;
            color: var(--primary-color);
            line-height: 1.1;
        }
        .stat-item .label {
            font-size: 14px;
            color: var(--text-color-light);
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }

        /* --- Gráfico --- */
        .chart-title {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-color-light);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .chart-container {
            background-color: var(--background-color);
            padding: 16px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        .relegation-zone {
            border-color: #dc3545 !important;
            box-shadow: 0 0 15px rgba(220, 53, 69, 0.3) !important;
        }
        .relegation-zone .pos {
            color: #dc3545;
        }
        .final-match-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: 40px 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }
        .final-player {
            text-align: center;
            width: 40%;
        }
        .final-player .logo {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid var(--gold);
            box-shadow: 0 0 25px rgba(255, 193, 7, 0.4);
            margin-bottom: 15px;
        }
        .final-player .name {
            font-size: 1.5em;
            font-weight: 700;
            color: #fff;
        }
        .final-player .title {
            font-size: 1em;
            color: var(--text-color-light);
        }
        .vs-container {
            font-size: 4em;
            font-weight: 800;
            color: var(--primary-color);
            text-shadow: 0 0 15px var(--primary-glow);
        }
        .final-result {
            text-align: center;
            font-size: 1.8em;
            font-weight: 600;
            margin-top: 20px;
        }
        .text-secondary { color: var(--text-secondary); }
    </style>
</head>
<body>
    <div class="container">
        <header class="app-header">
            <div class="header-content">
                <a href="home.html" class="logo">
                    <i class="fas fa-arrow-left" style="font-size: 1.1rem; margin-right: 0.5rem; color: var(--text-secondary);"></i>
                    BR<span>Depressão</span>
                </a>
                
                <div class="header-actions">
                    <a href="home.html" class="btn-icon">
                        <i class="fas fa-home"></i>
                    </a>
                    <button class="btn-icon" id="theme-toggle" aria-label="Alternar tema">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>
        </header>

        <h1 class="header-title"><i class="fas fa-trophy"></i> Superliga</h1>
        <div class="tabs">
            <div class="tab active" data-stage="abertura">Abertura</div>
            <div class="tab" data-stage="clausura">Clausura</div>
            <div class="tab" data-stage="final" style="display: none;">Final</div>
        </div>

        <div id="stages">
            <!-- Abertura Content -->
            <div class="stage-content" id="abertura-content">
                <div id="loading-abertura" class="text-secondary" style="text-align: center; padding: 20px;">Carregando Classificação...</div>
                
                <!-- Nova Estrutura de Tabela -->
                <div class="standings-container">
                    <table class="standings-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;">#</th>
                                <th>Jogador</th>
                                <th style="width: 80px; text-align: right;">PTS</th>
                                <th style="width: 80px; text-align: right;">+R</th>
                            </tr>
                        </thead>
                        <tbody id="abertura-list">
                            <!-- Lista Carregada Aqui -->
                        </tbody>
                    </table>
                </div>
                
                <div class="legend" style="margin-top: 20px; font-size: 0.9rem; color: var(--text-secondary);">
                    <span style="display: inline-block; margin-right: 15px;"><span style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: var(--accent-primary);"></span> Top 4</span>
                    <span style="display: inline-block; margin-right: 15px;"><span style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: var(--accent-success);"></span> Meio de Tabela</span>
                    <span style="display: inline-block;"><span style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: var(--accent-danger);"></span> Z4</span>
                </div>
            </div>

            <!-- Clausura Content -->
            <div class="stage-content" id="clausura-content" style="display:none;">
                <div id="loading-clausura" class="text-secondary" style="text-align: center; padding: 20px;">Carregando Classificação...</div>
                
                <div class="standings-container">
                    <table class="standings-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;">#</th>
                                <th>Jogador</th>
                                <th style="width: 80px; text-align: right;">PTS</th>
                                <th style="width: 80px; text-align: right;">+R</th>
                            </tr>
                        </thead>
                        <tbody id="clausura-list">
                            <!-- Lista Carregada Aqui -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Final Content -->
            <div class="stage-content" id="final-content" style="display:none;">
                <div id="loading-final" class="text-secondary" style="text-align: center; padding: 20px;">Carregando Final...</div>
                <div class="final-match-container">
                    <div class="final-player" id="final-player-home">
                        <img src="" alt="Logo" class="logo">
                        <div class="name">Aguardando...</div>
                        <div class="title text-secondary">Campeão da Abertura</div>
                    </div>
                    <div class="vs-container" style="color: var(--accent-primary); text-shadow: none;">
                        <span class="vs-text">VS</span>
                    </div>
                    <div class="final-player" id="final-player-away">
                        <img src="" alt="Logo" class="logo">
                        <div class="name">Aguardando...</div>
                        <div class="title text-secondary">Campeão da Clausura</div>
                    </div>
                </div>
                <div id="final-result" class="final-result" style="color: var(--accent-warning);"></div>
            </div>
        </div>
    </div>

    <dialog id="player-details-dialog">
        <div class="dialog-header">
            <h3><i class="fas fa-chart-line"></i> Detalhes do Jogador</h3>
            <button class="close-btn" aria-label="Fechar">×</button>
        </div>
        <div class="dialog-body">
            <div class="player-summary">
                <img src="" alt="Logo" class="logo" id="dialog-player-logo">
                <div class="info">
                    <div class="name" id="dialog-player-name"></div>
                    <div class="team" id="dialog-player-team"></div>
                </div>
            </div>
            <div class="player-stats">
                <!-- Estrutura com ícones para cada estatística -->
                <div class="stat-item">
                    <div class="value" id="dialog-player-position">#--</div>
                    <div class="label"><i class="fas fa-trophy"></i> Posição Atual</div>
                </div>
                <div class="stat-item">
                    <div class="value" id="dialog-player-points">--</div>
                    <div class="label"><i class="fas fa-star"></i> Pontos Totais</div>
                </div>
                <div class="stat-item">
                    <div class="value" id="dialog-player-avg">--</div>
                    <div class="label"><i class="fas fa-calculator"></i> Média / Rodada</div>
                </div>
                <div class="stat-item">
                    <div class="value" id="dialog-player-best">--</div>
                    <div class="label"><i class="fas fa-fire"></i> Melhor Rodada</div>
                </div>
            </div>
            
            <h4 class="chart-title">Desempenho Recente</h4>
            <div class="chart-container" style="height: 220px;">
                <canvas id="player-points-chart"></canvas>
            </div>
        </div>
    </dialog>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBBrIiwL2sUVEPc8YBzdkJxPVyVVC5QN1M",
            authDomain: "brdepre.firebaseapp.com",
            databaseURL: "https://brdepre-default-rtdb.firebaseio.com",
            projectId: "brdepre",
            storageBucket: "brdepre.firebasestorage.app",
            messagingSenderId: "1077826896098",
            appId: "1:1077826896098:web:abe2b07a280a4852649ebb",
            measurementId: "G-4JXFEZ8DW6"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        let teamsDataCache = null;
        let usersDataCache = null;
        let playerChartInstance = null;
        let completedRoundsCache = null; 

        let superligaDataCache = null;

        async function fetchSuperligaDataOnce() {
            if (superligaDataCache) return superligaDataCache;
            const snapshot = await database.ref('tournaments/superliga').once('value');
            superligaDataCache = snapshot.val();
            return superligaDataCache;
        }

        const ui = {
            tabs: document.querySelectorAll('.tab'),
            stages: document.querySelectorAll('.stage-content'),
            abertura: {
                list: document.getElementById('abertura-list'),
                loader: document.getElementById('loading-abertura')
            },
            clausura: {
                list: document.getElementById('clausura-list'),
                loader: document.getElementById('loading-clausura')
            },
            final: {
                content: document.getElementById('final-match-info'),
                loader: document.getElementById('loading-final'),
                homeLogo: document.getElementById('home-team-logo'),
                awayLogo: document.getElementById('away-team-logo'),
                homeName: document.getElementById('home-team-name'),
                awayName: document.getElementById('away-team-name'),
            },
            dialog: {
                element: document.getElementById('player-details-dialog'),
                closeBtn: document.querySelector('#player-details-dialog .close-btn'),
                logo: document.getElementById('dialog-player-logo'),
                name: document.getElementById('dialog-player-name'),
                team: document.getElementById('dialog-player-team'),
                points: document.getElementById('dialog-player-points'),
                position: document.getElementById('dialog-player-position'),
                chartCanvas: document.getElementById('player-points-chart'),
                avg: document.getElementById('dialog-player-avg'),
                best: document.getElementById('dialog-player-best'),
            },
            themeToggle: document.getElementById('theme-toggle')
        };

        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
            
            ui.themeToggle.addEventListener('click', () => {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeIcon(newTheme);
            });
        }

        function updateThemeIcon(theme) {
            const icon = ui.themeToggle.querySelector('i');
            icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }

        auth.onAuthStateChanged(user => {
            if (!user) {
                window.location.href = 'index.html';
            } else {
                initTheme();
                initializeApp();
            }
        });

        function renderPage(standings, stage) {
            // Removemos o renderPodium
            renderStandingsList(standings, stage); 

            // Adicionar listener de clique
            document.querySelectorAll(`#${stage}-content .standings-row`).forEach(row => {
                row.addEventListener('click', (e) => {
                    // Evita clicar no thead, embora o listener esteja no tbody
                    if (e.target.tagName === 'TH') return;
                    const userId = row.dataset.userid;
                    const stage = row.dataset.stage;
                    const position = row.dataset.position;
                    showPlayerDetails(userId, stage, position);
                });
            });
        }

        // --- FUNÇÃO PARA RENDERIZAR O PÓDIO ---
        function renderPodium(players, stage) {
            const container = document.getElementById(`podium-container-${stage}`);
            if (!container) return;

            const podiumOrder = [players[1], players[0], players[2]].filter(Boolean); // Reordena para 2º, 1º, 3º
            container.innerHTML = podiumOrder.map(user => {
                const team = teamsDataCache[user.teamId] || {};
                const position = user.position;
                return `
                    <div class="podium-card pos-${position}" data-userid="${user.id}" data-stage="${stage}" data-position="${position}" style="animation-delay: ${position * 100}ms">
                        <div class="position-badge">${position}º</div>
                        <img src="${team.image}" alt="${team.name}" class="logo">
                        <div class="name">${user.name}</div>
                        <div class="points">${user.totalPoints} pts</div>
                    </div>
                `;
            }).join('');
        }

        function renderStandingsList(players, stage) {
            const list = document.getElementById(`${stage}-list`);
            if (!list) return;
            const currentUser = auth.currentUser;
            
            // Regras de Classificação (Assumindo 20 jogadores)
            const totalPlayers = players.length; // Usamos o tamanho real dos jogadores
            const Z4_START = totalPlayers - 3; // Posição 17, 18, 19, 20 (4 últimos)
            const MID_TABLE_END = 12; // Top 12
            const TOP_4_END = 4; // Top 4

            list.innerHTML = players.map(user => {
                const team = teamsDataCache[user.teamId] || {};
                const isCurrentUser = user.id === currentUser.uid;
                const position = user.position;
                
                let rowClass = '';
                let posColor = 'var(--text-tertiary)';

                if (position <= TOP_4_END) {
                    rowClass = 'top-4';
                    posColor = 'var(--accent-primary)';
                } else if (position <= MID_TABLE_END) {
                    rowClass = 'mid-table';
                    posColor = 'var(--accent-success)';
                } else if (position >= Z4_START) {
                    rowClass = 'z4';
                    posColor = 'var(--accent-danger)';
                }
                
                // Tratar caso de Hot Streak: ícone adicional
                const hotStreakIcon = user.hasHotStreak ? 
                    '<i class="fas fa-fire" style="color: var(--accent-warning);" title="Em sequência quente!"></i>' : '';
                
                // Avatar fallback
                const avatarUrl = team.image || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name || '?')}&background=3b82f6&color=fff`;

                return `
                    <tr class="standings-row ${rowClass} ${isCurrentUser ? 'current-user-row' : ''}" 
                        data-userid="${user.id}" data-stage="${stage}" data-position="${position}"
                    >
                        <td style="color: ${posColor}; font-weight: 600;">${position}</td>
                        <td>
                            <div class="player-cell">
                                <img src="${avatarUrl}" alt="${team.name}" class="player-logo">
                                <span class="player-name">${user.name}</span>
                                ${isCurrentUser ? '<span class="current-user-badge" style="font-size: 10px; background: var(--accent-primary); color: white; padding: 2px 6px; border-radius: 4px;">VOCÊ</span>' : ''}
                                ${hotStreakIcon}
                            </div>
                        </td>
                        <td class="points-col" style="text-align: right;">${user.totalPoints}</td>
                        <td class="round-points-col" style="text-align: right;">+${user.roundPoints}</td>
                    </tr>
                `;
            }).join('');
        }

        async function initializeApp() {
            try {
                // Busca todos os dados necessários em paralelo
                await Promise.all([
                    loadTeamsDataOnce(), 
                    loadUsersDataOnce(),
                    fetchSuperligaDataOnce() // Busca os dados da Superliga
                ]);

                const stages = superligaDataCache.stages;
                let activeStageKey = 'clausura'; // Padrão

                // Lógica para determinar qual estágio está ativo (status: 1)
                if (stages.clausura.status === 1) {
                    activeStageKey = 'clausura';
                } else if (stages.abertura.status === 1) {
                    activeStageKey = 'abertura';
                }

                // Lógica para exibir a aba "Final"
                const finalTab = document.querySelector('.tab[data-stage="final"]');
                if (stages.abertura.status === 2 && stages.clausura.status === 2) {
                    finalTab.style.display = 'block';
                    activeStageKey = 'final'; // A final se torna o estágio ativo
                }
                
                // Ativa a aba e o conteúdo corretos
                ui.tabs.forEach(tab => {
                    const stage = tab.dataset.stage;
                    const content = document.getElementById(`${stage}-content`);
                    
                    if (stage === activeStageKey) {
                        tab.classList.add('active');
                        content.style.display = 'block';
                        loadStageData(stage); // Carrega os dados do estágio ativo
                    } else {
                        tab.classList.remove('active');
                        content.style.display = 'none';
                    }
                });

                setupEventListeners();

            } catch (error) {
                console.error("Erro na inicialização:", error);
            }
        }

        async function loadTeamsDataOnce() {
            if (teamsDataCache) return;
            const snapshot = await database.ref('teams').once('value');
            teamsDataCache = snapshot.val() || {};
        }

        async function loadUsersDataOnce() {
            if (usersDataCache) return;
            const snapshot = await database.ref('users').once('value');
            usersDataCache = snapshot.val() || {};
            for (const userId in usersDataCache) {
                usersDataCache[userId].id = userId;
            }
        }

        async function loadStageData(stage) {
            if (stage === 'final') {
                await loadFinalInfo();
                return;
            }

            const loader = ui[stage].loader;
            const list = ui[stage].list;
            loader.style.display = 'block';
            list.innerHTML = '';

            const [activeRound, usersWithStreaks] = await Promise.all([findActiveRound(), getUsersWithHotStreaks()]);
            const liveRoundPoints = calculateLiveRoundPoints(activeRound);
            
            const pointsField = `pointsSuperliga${stage.charAt(0).toUpperCase() + stage.slice(1)}`;
            const lastRoundPointsField = `lastRoundPointsLiga${stage.charAt(0).toUpperCase() + stage.slice(1)}`;
            
            const usersArray = Object.values(usersDataCache);
            
            const standings = usersWithStreaks
                .filter(user => user[pointsField] !== undefined)
                .map((user, index) => {
                    let roundPoints = activeRound ? (liveRoundPoints[user.id] || 0) : (user[lastRoundPointsField] || 0);
                    const totalPoints = (user[pointsField] || 0) + roundPoints;
                    return { ...user, totalPoints, roundPoints, position: 0 }; // Posição será definida após ordenar
                })
                .sort((a, b) => b.totalPoints - a.totalPoints || b.roundPoints - a.roundPoints)
                .map((user, index) => ({ ...user, position: index + 1 })); // Atribui a posição correta
            
            renderPage(standings, stage);
            loader.style.display = 'none';
        }

        // --- NOVA LÓGICA PARA "HOT STREAK" ---
        async function fetchCompletedRoundsOnce() {
            if (completedRoundsCache) return completedRoundsCache;
            const snapshot = await database.ref('rounds').orderByChild('status').equalTo(2).once('value');
            completedRoundsCache = snapshot.val() || {};
            return completedRoundsCache;
        }

        async function getUsersWithHotStreaks() {
            const completedRounds = await fetchCompletedRoundsOnce();
            const usersArray = Object.values(usersDataCache);
            if (Object.keys(completedRounds).length < 2) return usersArray;

            const lastTwoRounds = Object.values(completedRounds).sort((a,b) => b.finishTimestamp - a.finishTimestamp).slice(0, 2);
            
            return usersArray.map(user => {
                let consecutiveHighScores = 0;
                for (const round of lastTwoRounds) {
                    let pointsInRound = 0;
                    if (round.matches) {
                        for (const match of Object.values(round.matches)) {
                            if (match.predictions?.[user.id]) {
                                pointsInRound += calculateMatchPoints(match.finalResult, match.predictions[user.id]);
                            }
                        }
                    }
                    if (pointsInRound >= 10) { // Limite para considerar "alta pontuação"
                        consecutiveHighScores++;
                    }
                }
                return { ...user, hasHotStreak: consecutiveHighScores === 2 };
            });
        }

        function renderStandings(list, standings, stage) {
            const currentUser = auth.currentUser;
            list.innerHTML = standings.map((user, index) => {
                const team = teamsDataCache[user.teamId] || {};
                const isCurrentUser = user.id === currentUser.uid;
                const position = index + 1;

                return `
                    <li class="player-card ${isCurrentUser ? 'current-user-row' : ''} position-${position}" data-userid="${user.id}" data-stage="${stage}" data-position="${position}">
                        <span class="pos">${position}</span>
                        <img src="${team.image || ''}" alt="${team.name || ''}" class="logo">
                        <span class="name">${user.name}</span>
                        <div class="points-info">
                            <div class="total-points">${user.totalPoints}</div>
                            <div class="round-points">+${user.roundPoints}</div>
                        </div>
                    </li>
                `;
            }).join('');

            list.querySelectorAll('.player-card').forEach(card => {
                card.addEventListener('click', () => {
                    const userId = card.dataset.userid;
                    const stage = card.dataset.stage;
                    const position = card.dataset.position;
                    showPlayerDetails(userId, stage, position);
                });
            });
        }

        async function showPlayerDetails(userId, stage, position) {
            const user = usersDataCache[userId];
            const team = teamsDataCache[user.teamId] || {};

            // 1. Preenche as informações básicas do jogador no modal
            ui.dialog.logo.src = team.image || 'default-avatar.png';
            ui.dialog.name.textContent = user.name;
            ui.dialog.team.textContent = team.name || 'Sem time';
            ui.dialog.position.textContent = `#${position}`;

            // 2. Busca o histórico de pontos de todas as rodadas finalizadas (status: 2)
            // Usa o cache (completedRoundsCache) para não buscar no DB toda vez
            const completedRounds = await fetchCompletedRoundsOnce();
            const historyData = [];
            let totalPointsAccumulated = 0;

            // Garante que as rodadas sejam processadas em ordem cronológica
            const sortedRounds = Object.values(completedRounds).sort((a, b) => a.finishTimestamp - b.finishTimestamp);

            sortedRounds.forEach((round, index) => {
                let pointsInRound = 0;
                if (round.matches) {
                    for (const match of Object.values(round.matches)) {
                        if (match.predictions?.[userId]) {
                            // Reutiliza a função de cálculo de pontos de um palpite
                            pointsInRound += calculateMatchPoints(match.finalResult, match.predictions[userId]);
                        }
                    }
                }
                totalPointsAccumulated += pointsInRound;
                historyData.push({ round: index + 1, points: pointsInRound });
            });

            // 3. Calcula as novas estatísticas
            const bestRoundPoints = historyData.length > 0 ? Math.max(...historyData.map(h => h.points)) : 0;
            const avgPoints = historyData.length > 0 ? (totalPointsAccumulated / historyData.length).toFixed(1) : "0.0";
            
            // Obtém o total de pontos do estágio atual (pode incluir pontos parciais da rodada ativa)
            const pointsField = `pointsSuperliga${stage.charAt(0).toUpperCase() + stage.slice(1)}`;
            const totalStagePoints = usersDataCache[userId][pointsField] || 0; // Você pode aprimorar isso para incluir pontos da rodada ativa se desejar
            
            // Preenche os campos de estatísticas no modal
            ui.dialog.points.textContent = totalStagePoints;
            ui.dialog.avg.textContent = avgPoints;
            ui.dialog.best.textContent = bestRoundPoints;

            // 4. Configura e renderiza o gráfico de desempenho
            const last12Rounds = historyData.slice(-12); // Pega as últimas 12 rodadas para o gráfico
            const chartLabels = last12Rounds.map(item => `R${item.round}`);
            const chartData = last12Rounds.map(item => item.points);

            // Destrói qualquer instância anterior do gráfico para evitar sobreposição
            if (playerChartInstance) {
                playerChartInstance.destroy();
            }

            // Configurações globais do Chart.js para o tema escuro
            Chart.defaults.color = '#b0b3b8';
            Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';

            playerChartInstance = new Chart(ui.dialog.chartCanvas, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'Pontos por Rodada',
                        data: chartData,
                        borderColor: 'rgba(0, 123, 255, 1)',
                        backgroundColor: 'rgba(0, 123, 255, 0.2)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4, // Suaviza a linha do gráfico
                        pointBackgroundColor: 'rgba(0, 123, 255, 1)',
                        pointRadius: 4,
                        pointHoverRadius: 6,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }, // Esconde a legenda do dataset
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            padding: 10,
                            cornerRadius: 8,
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { 
                                stepSize: 5, // Ajusta o intervalo no eixo Y
                                color: '#8e9aab' 
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)', // Linhas de grade mais sutis
                            }
                        },
                        x: {
                            ticks: { color: '#8e9aab' },
                            grid: { display: false } // Esconde as linhas de grade verticais
                        }
                    }
                }
            });

            // 5. Exibe o modal
            ui.dialog.element.showModal();
        }

        async function loadFinalInfo() {
            const loader = document.getElementById('loading-final');
            const finalContent = document.querySelector('.final-match-container');
            const finalResultEl = document.getElementById('final-result');
            
            loader.style.display = 'block';
            finalContent.style.display = 'none';

            const finalData = superligaDataCache.stages.final;

            // Busca dados dos dois finalistas
            const homePlayer = usersDataCache[finalData.homeTeam];
            const awayPlayer = usersDataCache[finalData.awayTeam];
            const homeTeamInfo = teamsDataCache[homePlayer.teamId];
            const awayTeamInfo = teamsDataCache[awayPlayer.teamId];

            // Preenche os dados do jogador 1 (campeão da Abertura)
            const homeContainer = document.getElementById('final-player-home');
            homeContainer.querySelector('.logo').src = homeTeamInfo.image;
            homeContainer.querySelector('.name').textContent = homePlayer.name;

            // Preenche os dados do jogador 2 (campeão da Clausura)
            const awayContainer = document.getElementById('final-player-away');
            awayContainer.querySelector('.logo').src = awayTeamInfo.image;
            awayContainer.querySelector('.name').textContent = awayPlayer.name;

            // Mostra o resultado, se houver
            if (finalData.result) {
                finalResultEl.textContent = `Resultado: ${finalData.result}`;
            }

            loader.style.display = 'none';
            finalContent.style.display = 'flex';
        }

        async function findActiveRound() {
            const snapshot = await database.ref('rounds').orderByChild('status').equalTo(1).limitToFirst(1).once('value');
            return snapshot.exists() ? Object.values(snapshot.val())[0] : null;
        }

        function calculateLiveRoundPoints(roundData) {
            if (!roundData || !roundData.matches) return {};
            const userRoundPoints = {};
            const playersWithPredictions = new Set();
            
            Object.values(roundData.matches).forEach(match => {
                if(match.predictions) {
                    Object.keys(match.predictions).forEach(playerId => playersWithPredictions.add(playerId));
                }
            });

            playersWithPredictions.forEach(playerId => {
                userRoundPoints[playerId] = 0;
                Object.values(roundData.matches).forEach(match => {
                    if (match.finalResult && match.predictions?.[playerId]) {
                        userRoundPoints[playerId] += calculateMatchPoints(match.finalResult, match.predictions[playerId]);
                    }
                });
            });
            return userRoundPoints;
        }

        function calculateMatchPoints(final, pred) {
            if (!final || final.homeScore === undefined || !pred || pred.homeScore === undefined) return 0;
            if (final.homeScore === pred.homeScore && final.awayScore === pred.awayScore) return 3;
            const finalWinner = Math.sign(final.homeScore - final.awayScore);
            const predWinner = Math.sign(pred.homeScore - pred.awayScore);
            if (finalWinner === predWinner) return 1;
            if (final.homeScore === pred.awayScore && final.awayScore === pred.homeScore) return -1;
            return 0;
        }

        function setupEventListeners() {
            ui.tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    ui.tabs.forEach(t => t.classList.remove('active'));
                    ui.stages.forEach(c => c.style.display = 'none');
                    tab.classList.add('active');
                    const stage = tab.dataset.stage;
                    document.getElementById(`${stage}-content`).style.display = 'block';
                    loadStageData(stage);
                });
            });

            ui.dialog.closeBtn.addEventListener('click', () => {
                ui.dialog.element.close();
            });
            ui.dialog.element.addEventListener('click', (e) => {
                if (e.target.id === 'player-details-dialog') {
                    ui.dialog.element.close();
                }
            });
        }
    </script>
</body>
</html>