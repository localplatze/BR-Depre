<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Superliga - Detalhes</title>
    <link rel="icon" href="./bdd.png" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4a65f5;
            --background-color: #f5f7fa;
            --card-bg-color: #ffffff;
            --text-color: #34495e;
            --text-color-light: #7f8c8d;
            --border-color: #eef2f7;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
            --border-radius: 12px;
            --accent-green: #2ecc71;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            -webkit-font-smoothing: antialiased;
        }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .header-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        /* Abas de Navegação */
        .tabs {
            display: flex;
            margin-bottom: 25px;
            background-color: var(--card-bg-color);
            border-radius: var(--border-radius);
            padding: 8px;
            box-shadow: var(--shadow);
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-align: center;
            flex: 1;
            border: none;
        }
        .tab:hover { background-color: rgba(74, 101, 245, 0.1); }
        .tab.active { background-color: var(--primary-color); color: white; }
        
        /* Conteúdo e Tabela */
        .stage-content {
            background-color: var(--card-bg-color);
            padding: 24px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        .standings-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 10px;
            margin-top: 10px;
        }
        .standings-table th {
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: var(--text-color-light);
            font-size: 13px;
            text-transform: uppercase;
        }
        .standings-table td { padding: 12px 15px; vertical-align: middle; }
        .standings-table tbody tr {
            background-color: #fcfdff;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .standings-table tbody tr:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.08);
        }
        .standings-table .current-user-row {
            background-color: #e9efff;
            border: 1px solid var(--primary-color);
        }
        
        /* Células da Tabela */
        .pos-cell, .pts-cell, .round-pts-cell { text-align: center; font-weight: 700; }
        .pos-cell { width: 50px; }
        .player-info-cell { display: flex; align-items: center; gap: 15px; }
        .player-logo { width: 28px; height: 28px; object-fit: contain; }
        .player-name { font-weight: 500; }
        .round-pts-cell { color: var(--accent-green); }

        /* Final Card */
        .final-card {
            text-align: center;
            padding: 30px;
        }
        .final-match-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
        }
        .finalist-player { display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .finalist-player .player-logo { width: 80px; height: 80px; }
        .finalist-player .player-name { font-size: 18px; font-weight: 600; }
        .final-vs { font-size: 24px; font-weight: 700; color: var(--text-color-light); }

        .loading, .empty-state { text-align: center; padding: 40px; color: var(--text-color-light); }

        /* Estilo para a faixa colorida lateral */
        .standings-table td:first-child, .standings-table th:first-child {
            position: relative;
            padding-left: 20px; /* Aumenta o padding para dar espaço à faixa */
        }

        .standings-table td:first-child::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 5px; /* Largura da faixa colorida */
            height: 100%;
            background-color: transparent; /* Cor padrão */
            border-top-left-radius: var(--border-radius);
            border-bottom-left-radius: var(--border-radius);
        }

        /* Cores da Classificação (Libertadores, Pré-Libertadores, etc.) */
        /* G4 - Azul (Libertadores Direta) */
        .position-1 td:first-child::before,
        .position-2 td:first-child::before,
        .position-3 td:first-child::before,
        .position-4 td:first-child::before {
            background-color: #007bff;
        }

        /* G6 - Laranja (Pré-Libertadores) */
        .position-5 td:first-child::before,
        .position-6 td:first-child::before {
            background-color: #fd7e14;
        }

        /* Sul-Americana - Verde */
        .position-7 td:first-child::before,
        .position-8 td:first-child::before,
        .position-9 td:first-child::before,
        .position-10 td:first-child::before,
        .position-11 td:first-child::before,
        .position-12 td:first-child::before {
            background-color: #28a745;
        }

        /* Z4 - Vermelho (Rebaixamento) */
        .position-18 td:first-child::before,
        .position-19 td:first-child::before,
        .position-20 td:first-child::before,
        .position-21 td:first-child::before {
            background-color: #dc3545;
        }

        .position-22 td:first-child::before,
        .position-23 td:first-child::before {
            background-color: #242424;
        }

        /* Ajuste fino na célula de posição para alinhar com a faixa */
        .pos-cell {
            width: 60px; /* Garante espaço suficiente */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="header-title"><i class="fas fa-trophy"></i>Superliga</h1>
        <div class="tabs">
            <div class="tab active" data-stage="abertura">Abertura</div>
            <div class="tab" data-stage="clausura">Clausura</div>
            <div class="tab" data-stage="final">Final</div>
        </div>

        <div id="stages">
            <!-- Conteúdo Abertura -->
            <div class="stage-content" id="abertura-content">
                <table class="standings-table" id="abertura-table">
                    <thead>
                        <tr>
                            <th class="pos-cell">Pos</th>
                            <th>Jogador</th>
                            <th class="pts-cell">Pts</th>
                            <th class="round-pts-cell">R</th>
                        </tr>
                    </thead>
                    <tbody><!-- Carregado pelo JS --></tbody>
                </table>
                <div id="loading-abertura" class="loading">Carregando...</div>
            </div>

            <!-- Conteúdo Clausura -->
            <div class="stage-content" id="clausura-content" style="display:none;">
                <table class="standings-table" id="clausura-table">
                    <thead>
                        <tr>
                            <th class="pos-cell">Pos</th>
                            <th>Jogador</th>
                            <th class="pts-cell">Pts</th>
                            <th class="round-pts-cell">R</th>
                        </tr>
                    </thead>
                    <tbody><!-- Carregado pelo JS --></tbody>
                </table>
                 <div id="loading-clausura" class="loading">Carregando...</div>
            </div>

            <!-- Conteúdo Final -->
            <div class="stage-content" id="final-content" style="display:none;">
                <div id="final-match-info" class="final-card">
                     <div class="final-match-container">
                        <div class="finalist-player">
                            <img id="home-team-logo" class="player-logo" src="" alt="Escudo">
                            <span id="home-team-name">A Definir</span>
                        </div>
                        <span class="final-vs">vs</span>
                        <div class="finalist-player">
                            <img id="away-team-logo" class="player-logo" src="" alt="Escudo">
                            <span id="away-team-name">A Definir</span>
                        </div>
                    </div>
                </div>
                 <div id="loading-final" class="loading">Carregando...</div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBBrIiwL2sUVEPc8YBzdkJxPVyVVC5QN1M",
            authDomain: "brdepre.firebaseapp.com",
            databaseURL: "https://brdepre-default-rtdb.firebaseio.com",
            projectId: "brdepre",
            storageBucket: "brdepre.firebasestorage.app",
            messagingSenderId: "1077826896098",
            appId: "1:1077826896098:web:abe2b07a280a4852649ebb",
            measurementId: "G-4JXFEZ8DW6"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        let teamsDataCache = null;
        let usersDataCache = null;

        const ui = {
            tabs: document.querySelectorAll('.tab'),
            stages: document.querySelectorAll('.stage-content'),
            abertura: {
                tableBody: document.querySelector('#abertura-table tbody'),
                loader: document.getElementById('loading-abertura')
            },
            clausura: {
                tableBody: document.querySelector('#clausura-table tbody'),
                loader: document.getElementById('loading-clausura')
            },
            final: {
                content: document.getElementById('final-match-info'),
                loader: document.getElementById('loading-final'),
                homeLogo: document.getElementById('home-team-logo'),
                awayLogo: document.getElementById('away-team-logo'),
                homeName: document.getElementById('home-team-name'),
                awayName: document.getElementById('away-team-name'),
            }
        };

        auth.onAuthStateChanged(user => {
            if (!user) {
                window.location.href = 'index.html';
            } else {
                initializeApp();
            }
        });

        async function initializeApp() {
            try {
                await Promise.all([loadTeamsDataOnce(), loadUsersDataOnce()]);
                loadStageData('abertura');
                setupEventListeners();
            } catch (error) {
                console.error("Erro na inicialização:", error);
            }
        }

        async function loadTeamsDataOnce() {
            if (teamsDataCache) return;
            const snapshot = await database.ref('teams').once('value');
            teamsDataCache = snapshot.val() || {};
        }

        async function loadUsersDataOnce() {
            if (usersDataCache) return;
            const snapshot = await database.ref('users').once('value');
            usersDataCache = snapshot.val() || {};
            for (const userId in usersDataCache) {
                usersDataCache[userId].id = userId;
            }
        }

        async function loadStageData(stage) {
            if (stage === 'final') {
                await loadFinalInfo();
                return;
            }

            const loader = ui[stage].loader;
            const tableBody = ui[stage].tableBody;

            loader.style.display = 'block';
            tableBody.innerHTML = '';

            const activeRound = await findActiveRound();
            const liveRoundPoints = calculateLiveRoundPoints(activeRound);
            
            const pointsField = `pointsSuperliga${stage.charAt(0).toUpperCase() + stage.slice(1)}`;
            const lastRoundPointsField = `lastRoundPointsLiga${stage.charAt(0).toUpperCase() + stage.slice(1)}`;
            
            const usersArray = Object.values(usersDataCache);
            
            const standings = usersArray
                .filter(user => user[pointsField] !== undefined)
                .map(user => {
                    let roundPoints = 0;
                    if (activeRound) {
                        roundPoints = liveRoundPoints[user.id] || 0;
                    } else {
                        roundPoints = user[lastRoundPointsField] || 0;
                    }
                    const totalPoints = (user[pointsField] || 0) + roundPoints;
                    return { ...user, totalPoints, roundPoints };
                })
                .sort((a, b) => b.totalPoints - a.totalPoints || b.roundPoints - a.roundPoints);

            renderStandings(tableBody, standings);
            loader.style.display = 'none';
        }

        function renderStandings(tableBody, standings) {
            const currentUser = auth.currentUser;
            tableBody.innerHTML = standings.map((user, index) => {
                const team = teamsDataCache[user.teamId] || {};
                const isCurrentUser = user.id === currentUser.uid;
                const position = index + 1; // Posição para a classe CSS

                // **A CORREÇÃO ESTÁ AQUI:**
                // A classe `position-${position}` é adicionada ao `<tr>`
                return `
                    <tr class="${isCurrentUser ? 'current-user-row' : ''} position-${position}">
                        <td class="pos-cell">${position}</td>
                        <td>
                            <div class="player-info-cell">
                                <img src="${team.image || ''}" alt="${team.name || ''}" class="player-logo">
                                <span class="player-name">${user.name}</span>
                            </div>
                        </td>
                        <td class="pts-cell">${user.totalPoints}</td>
                        <td class="round-pts-cell">+${user.roundPoints}</td>
                    </tr>
                `;
            }).join('');
        }

        async function loadFinalInfo() {
            ui.final.loader.style.display = 'block';
            ui.final.content.style.display = 'none';

            const finalRef = database.ref('tournaments/superliga/stages/final');
            const snapshot = await finalRef.once('value');
            const finalData = snapshot.val();
            
            const homePlayer = usersDataCache[finalData?.homeTeam];
            const awayPlayer = usersDataCache[finalData?.awayTeam];

            if (homePlayer && awayPlayer) {
                const homeTeam = teamsDataCache[homePlayer.teamId];
                const awayTeam = teamsDataCache[awayPlayer.teamId];
                ui.final.homeLogo.src = homeTeam.image;
                ui.final.homeName.textContent = homePlayer.name;
                ui.final.awayLogo.src = awayTeam.image;
                ui.final.awayName.textContent = awayPlayer.name;
            } else {
                ui.final.homeName.textContent = "A Definir";
                ui.final.awayName.textContent = "A Definir";
            }

            ui.final.loader.style.display = 'none';
            ui.final.content.style.display = 'block';
        }

        async function findActiveRound() {
            const snapshot = await database.ref('rounds').orderByChild('status').equalTo(1).limitToFirst(1).once('value');
            return snapshot.exists() ? Object.values(snapshot.val())[0] : null;
        }

        function calculateLiveRoundPoints(roundData) {
            if (!roundData || !roundData.matches) return {};
            const userRoundPoints = {};
            const playersWithPredictions = new Set();
            
            Object.values(roundData.matches).forEach(match => {
                if(match.predictions) {
                    Object.keys(match.predictions).forEach(playerId => playersWithPredictions.add(playerId));
                }
            });

            playersWithPredictions.forEach(playerId => {
                userRoundPoints[playerId] = 0;
                Object.values(roundData.matches).forEach(match => {
                    if (match.finalResult && match.predictions?.[playerId]) {
                        userRoundPoints[playerId] += calculateMatchPoints(match.finalResult, match.predictions[playerId]);
                    }
                });
            });
            return userRoundPoints;
        }

        function calculateMatchPoints(final, pred) {
            if (final.homeScore === null || pred.homeScore === null) return 0;
            if (final.homeScore === pred.homeScore && final.awayScore === pred.awayScore) return 3;
            const finalWinner = Math.sign(final.homeScore - final.awayScore);
            const predWinner = Math.sign(pred.homeScore - pred.awayScore);
            if (finalWinner === predWinner) return 1;
            if (final.homeScore === pred.awayScore && final.awayScore === pred.homeScore) return -1;
            return 0;
        }

        function setupEventListeners() {
            ui.tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    ui.tabs.forEach(t => t.classList.remove('active'));
                    ui.stages.forEach(c => c.style.display = 'none');
                    tab.classList.add('active');
                    const stage = tab.dataset.stage;
                    document.getElementById(`${stage}-content`).style.display = 'block';
                    loadStageData(stage);
                });
            });
        }
    </script>
</body>
</html>