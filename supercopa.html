<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supercopa - BR da Depressão</title>
    <link rel="icon" href="./bdd.png" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007bff;
            --primary-glow: rgba(0, 123, 255, 0.5);
            --background-color: #101418;
            --card-bg-color: #1a2027;
            --card-bg-light: #242c36;
            --text-color: #e4e6eb;
            --text-color-light: #b0b3b8;
            --border-color: rgba(255, 255, 255, 0.1);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --border-radius: 12px;
            --gold: #ffc107; --silver: #c0c0c0; --bronze: #cd7f32; --mud: #795548;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--background-color); color: var(--text-color); }
        .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
        .header-title { font-size: 32px; font-weight: 700; margin-bottom: 30px; display: flex; align-items: center; gap: 15px; color: #fff; }
        .tabs { display: flex; margin-bottom: 30px; background-color: var(--card-bg-color); border-radius: var(--border-radius); padding: 8px; border: 1px solid var(--border-color); }
        .tab { padding: 10px 20px; cursor: pointer; border-radius: 8px; font-weight: 600; transition: all 0.3s ease; text-align: center; flex: 1; border: none; background: none; color: var(--text-color-light); }
        .tab.active { background-color: var(--primary-color); color: white; }

        /* --- CONTEÚDO DA FASE DE GRUPOS --- */
        .group-tabs-container { display: flex; justify-content: center; margin-bottom: 20px; }
        .group-tab { padding: 8px 16px; font-weight: 500; }
        .groups-content-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px; }
        .section-header { font-size: 24px; font-weight: 700; color: #fff; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        
        .standings-list { display: flex; flex-direction: column; gap: 10px; }
        .player-standing-card {
            display: grid; grid-template-columns: 30px 40px 1fr auto; align-items: center; gap: 15px;
            background: var(--card-bg-color); padding: 12px; border-radius: 8px;
            border-left: 5px solid transparent; transition: background-color 0.2s; animation: slideUp 0.5s ease-out backwards;
        }
        .player-standing-card:hover { background-color: var(--card-bg-light); }
        .player-standing-card .pos { font-weight: 700; color: var(--text-color-light); }
        .player-standing-card .logo { width: 32px; height: 32px; object-fit: contain; }
        .player-standing-card .name { font-weight: 600; }
        .player-standing-card .points { font-weight: 700; font-size: 1.1em; }
        .status-badge { font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 20px; color: #111; display: flex; align-items: center; gap: 5px; }

        /* DESTAQUES DE CLASSIFICAÇÃO */
        .status-classified { border-left-color: var(--gold); }
        .status-classified .status-badge { background-color: var(--gold); }
        .status-serie-b { border-left-color: var(--silver); }
        .status-serie-b .status-badge { background-color: var(--silver); }
        .status-serie-c { border-left-color: var(--mud); }
        .status-serie-c .status-badge { background-color: var(--mud); color: #fff; }

        /* --- CONTEÚDO DO MATA-MATA --- */
        .knockout-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 30px; }
        .knockout-series-container { display: flex; flex-direction: column; gap: 15px; }
        .series-title { font-size: 1.5em; font-weight: 700; color: #fff; text-align: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 2px solid; }
        .series-a .series-title { border-color: var(--gold); }
        .series-b .series-title { border-color: var(--silver); }
        .series-c .series-title { border-color: var(--mud); }
        
        .match-card { display: flex; align-items: center; background-color: var(--card-bg-color); border-radius: var(--border-radius); padding: 16px; border: 1px solid var(--border-color); animation: fadeIn 0.5s ease-out backwards; }
        .match-player { display: flex; align-items: center; gap: 10px; flex: 1; }
        .match-player.away { justify-content: flex-end; text-align: right; }
        .match-player .logo { width: 40px; height: 40px; }
        .match-player .name { font-weight: 600; }
        .match-result { font-size: 1.5em; font-weight: 800; color: var(--primary-color); padding: 0 20px; }

        .empty-state { text-align: center; padding: 40px; color: var(--text-color-light); font-style: italic; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="header-title"><i class="fas fa-shield-alt"></i> Supercopa</h1>
        <div class="tabs main-tabs">
            <div class="tab active" data-stage="groups">Fase de Grupos</div>
            <div class="tab" data-stage="quarterFinals">Quartas</div>
            <div class="tab" data-stage="semiFinals">Semifinais</div>
            <div class="tab" data-stage="final">Final</div>
        </div>

        <!-- Conteúdo da Fase de Grupos -->
        <div id="groups-stage-content">
            <div class="tabs group-tabs-container">
                <div class="tab group-tab active" data-group="group1">Grupo A</div>
                <div class="tab group-tab" data-group="group2">Grupo B</div>
                <div class="tab group-tab" data-group="group3">Grupo C</div>
                <div class="tab group-tab" data-group="group4">Grupo D</div>
            </div>
            <div class="groups-content-grid">
                <div id="standings-container">
                    <h2 class="section-header"><i class="fas fa-list-ol"></i> Classificação</h2>
                    <div id="standings-list" class="standings-list"></div>
                </div>
                 <div id="matches-container">
                    <h2 class="section-header"><i class="fas fa-futbol"></i> Jogos da Rodada Ativa</h2>
                    <div id="matches-list" class="standings-list"></div>
                </div>
            </div>
        </div>

        <!-- Conteúdo do Mata-Mata -->
        <div id="knockout-stage-content" style="display:none;">
             <h2 class="section-header" id="knockout-title-main"></h2>
             <div class="knockout-grid">
                <div class="knockout-series-container series-a">
                    <h3 class="series-title">Série A</h3>
                    <div id="knockout-matches-a"></div>
                </div>
                <div class="knockout-series-container series-b">
                    <h3 class="series-title">Série B</h3>
                    <div id="knockout-matches-b"></div>
                </div>
                <div class="knockout-series-container series-c">
                    <h3 class="series-title">Série C</h3>
                    <div id="knockout-matches-c"></div>
                </div>
             </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

        <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBBrIiwL2sUVEPc8YBzdkJxPVyVVC5QN1M",
            authDomain: "brdepre.firebaseapp.com",
            databaseURL: "https://brdepre-default-rtdb.firebaseio.com",
            projectId: "brdepre",
            storageBucket: "brdepre.firebasestorage.app",
            messagingSenderId: "1077826896098",
            appId: "1:1077826896098:web:abe2b07a280a4852649ebb",
            measurementId: "G-4JXFEZ8DW6"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // --- VARIÁVEIS DE CACHE GLOBAIS ---
        let teamsDataCache = null;
        let usersDataCache = null;
        let supercopaDataCache = null;
        let activeSuperligaRoundData = null;

        // --- MAPEAMENTO DA UI ---
        const ui = {
            mainTabs: document.querySelectorAll('.main-tabs .tab'),
            groupTabs: document.querySelectorAll('.group-tabs-container .tab'),
            groupsContent: document.getElementById('groups-stage-content'),
            knockoutContent: document.getElementById('knockout-stage-content'),
            standingsList: document.getElementById('standings-list'),
            matchesList: document.getElementById('matches-list'),
            knockoutTitleMain: document.getElementById('knockout-title-main'),
            knockoutMatches: {
                a: document.getElementById('knockout-matches-a'),
                b: document.getElementById('knockout-matches-b'),
                c: document.getElementById('knockout-matches-c'),
            }
        };

        // --- INICIALIZAÇÃO ---
        auth.onAuthStateChanged(user => {
            if (user) {
                initializeApp();
            } else {
                window.location.href = 'index.html';
            }
        });

        async function initializeApp() {
            try {
                // ETAPA 1: Garante que TODOS os dados essenciais sejam carregados ANTES de qualquer outra coisa.
                await Promise.all([
                    loadDataOnce('teams').then(data => teamsDataCache = data),
                    loadDataOnce('users').then(data => {
                        // Adiciona o ID a cada objeto de usuário para facilitar o acesso
                        Object.keys(data).forEach(key => data[key].id = key);
                        usersDataCache = data;
                    }),
                    loadDataOnce('tournaments/supercopa').then(data => supercopaDataCache = data),
                ]);
                
                // ETAPA 2: Inicia o listener para a rodada da Superliga (para os placares ao vivo)
                findActiveSuperligaRoundAndListen();
                
                // ETAPA 3: Configura os botões e abas
                setupEventListeners();
                
                // ETAPA 4: Lógica para determinar o estágio ativo da Supercopa
                const { groups, quarterFinals, semiFinals, final } = supercopaDataCache || {};
                let activeStage = 'groups';
                if (final?.status === 1) activeStage = 'final';
                else if (semiFinals?.status === 1) activeStage = 'semiFinals';
                else if (quarterFinals?.status === 1) activeStage = 'quarterFinals';
                
                // ETAPA 5: Clica programaticamente na aba correta para iniciar a renderização
                const activeTab = document.querySelector(`.main-tabs .tab[data-stage="${activeStage}"]`);
                if (activeTab) {
                    activeTab.click();
                } else {
                    // Fallback para o primeiro tab se nada for encontrado
                    document.querySelector('.main-tabs .tab').click();
                }

            } catch (error) {
                console.error("Erro fatal na inicialização:", error);
                document.body.innerHTML = '<div class="empty-state">Ocorreu um erro ao carregar os dados. Por favor, tente novamente.</div>';
            }
        }

        // --- FUNÇÕES DE DADOS ---
        async function loadDataOnce(path) {
            const snapshot = await database.ref(path).once('value');
            return snapshot.val() || {};
        }

        function findActiveSuperligaRoundAndListen() {
            database.ref('rounds').orderByChild('status').equalTo(1).on('value', (snapshot) => {
                activeSuperligaRoundData = snapshot.exists() ? Object.values(snapshot.val())[0] : null;
                
                // Re-renderiza o conteúdo visível para atualizar os placares ao vivo
                const activeMainTab = document.querySelector('.main-tabs .tab.active');
                if (activeMainTab) {
                    loadStage(activeMainTab.dataset.stage);
                }
            });
        }
        
        // --- LÓGICA DE RENDERIZAÇÃO PRINCIPAL ---
        function loadStage(stage) {
            ui.groupsContent.style.display = stage === 'groups' ? 'block' : 'none';
            ui.knockoutContent.style.display = stage !== 'groups' ? 'block' : 'none';

            if (stage === 'groups') {
                const activeGroupTab = document.querySelector('.group-tabs-container .tab.active');
                if (activeGroupTab) {
                    loadGroupData(activeGroupTab.dataset.group);
                }
            } else {
                loadKnockoutData(stage);
            }
        }

        function loadGroupData(groupKey) {
            renderGroupStandings(groupKey);
            renderGroupMatches();
        }

        function loadKnockoutData(stageKey) {
            const stageNameMap = { quarterFinals: 'Quartas de Final', semiFinals: 'Semifinais', final: 'Final' };
            ui.knockoutTitleMain.textContent = stageNameMap[stageKey] || 'Mata-Mata';
            
            const stageData = supercopaDataCache[stageKey];
            
            renderKnockoutSeries(stageData?.matches, ui.knockoutMatches.a);
            renderKnockoutSeries(stageData?.b, ui.knockoutMatches.b);
            renderKnockoutSeries(stageData?.c, ui.knockoutMatches.c);
        }

        // --- FUNÇÕES DE RENDERIZAÇÃO DE COMPONENTES ---
        function renderGroupStandings(groupKey) {
            const { standings = {}, status, ...groups } = supercopaDataCache.groups || {};
            const groupPlayerIds = groups[groupKey] || [];
            
            const groupStandings = groupPlayerIds
                .map(id => standings[id])
                .filter(Boolean)
                .sort((a, b) => {
                    const a_gd = (a.goalsFor || 0) - (a.goalsAg || 0);
                    const b_gd = (b.goalsFor || 0) - (b.goalsAg || 0);
                    return (b.points || 0) - (a.points || 0) || (b.wins || 0) - (a.wins || 0) || b_gd - a_gd || (b.goalsFor || 0) - (a.goalsFor || 0);
                });

            ui.standingsList.innerHTML = groupStandings.map((playerData, index) => {
                const player = usersDataCache[playerData.playerId];
                // Se o jogador não for encontrado no cache, pula a renderização deste card
                if (!player) return ''; 
                
                const team = teamsDataCache[player.teamId] || {};
                const position = index + 1;
                
                let statusClass = '', statusHtml = '';
                if (status === 2) {
                    if (position <= 2) {
                        statusClass = 'status-classified';
                        statusHtml = `<div class="status-badge"><i class="fas fa-crown"></i> Série A</div>`;
                    } else if (position <= 4) {
                        statusClass = 'status-serie-b';
                        statusHtml = `<div class="status-badge"><i class="fas fa-arrow-up"></i> Série B</div>`;
                    } else {
                        statusClass = 'status-serie-c';
                        statusHtml = `<div class="status-badge"><i class="fas fa-poo"></i> O Limbo</div>`;
                    }
                }

                return `
                    <div class="player-standing-card ${statusClass}" style="animation-delay: ${index * 50}ms">
                        <span class="pos">${position}</span>
                        <img src="${team.image || ''}" alt="${player.name || ''}" class="logo">
                        <div class="name-container" style="flex-grow: 1;">
                            <div class="name">${player.name || 'Desconhecido'}</div>
                            ${statusHtml}
                        </div>
                        <div class="points">${playerData.points || 0}</div>
                    </div>
                `;
            }).join('') || `<div class="empty-state">Classificação indisponível.</div>`;
        }

        function renderGroupMatches() {
            const activeCopaRound = Object.values(supercopaDataCache.groups.rounds || {}).find(r => r.status === 1);
            if (!activeCopaRound || !activeCopaRound.matches) {
                ui.matchesList.innerHTML = `<div class="empty-state">Nenhum jogo da Supercopa ativo.</div>`;
                return;
            }
            ui.matchesList.innerHTML = Object.values(activeCopaRound.matches).map(match => renderMatchCard(match, true)).join('');
        }

        function renderKnockoutSeries(matches, container) {
            if (!matches) {
                container.innerHTML = `<div class="empty-state">Confrontos não definidos.</div>`;
                return;
            }
            container.innerHTML = Object.values(matches).map(match => renderMatchCard(match, false)).join('');
        }
        
        function renderMatchCard(match, isGroupStage) {
            const p1Id = isGroupStage ? match.player1Id : match.homeTeam;
            const p2Id = isGroupStage ? match.player2Id : match.awayTeam;

            const player1 = p1Id ? usersDataCache[p1Id] : null;
            const player2 = p2Id ? usersDataCache[p2Id] : null;
            
            const team1 = player1 ? teamsDataCache[player1.teamId] : null;
            const team2 = player2 ? teamsDataCache[player2.teamId] : null;
            
            let result = "vs";
            if (match.result && match.result.trim() !== "") {
                result = match.result;
            } else if (activeSuperligaRoundData && p1Id && p2Id) {
                const p1Score = calculateLiveRoundPoints(p1Id);
                const p2Score = calculateLiveRoundPoints(p2Id);
                result = `${p1Score} x ${p2Score}`;
            }

            return `
                <div class="match-card">
                    <div class="match-player">
                        <img src="${team1?.image || ''}" alt="" class="logo">
                        <span class="name">${player1?.abbr || 'A Definir'}</span>
                    </div>
                    <div class="match-result">${result}</div>
                    <div class="match-player away">
                        <span class="name">${player2?.abbr || 'A Definir'}</span>
                        <img src="${team2?.image || ''}" alt="" class="logo">
                    </div>
                </div>
            `;
        }
        
        // --- FUNÇÕES AUXILIARES ---
        function calculateLiveRoundPoints(playerId) {
            if (!activeSuperligaRoundData || !playerId) return usersDataCache[playerId]?.lastRoundPointsLigaAbertura || 0;
            let points = 0;
            for (const match of Object.values(activeSuperligaRoundData.matches)) {
                if (match.finalResult && match.predictions?.[playerId]) {
                    points += calculateMatchPoints(match.finalResult, match.predictions[playerId]);
                }
            }
            return points;
        }

        function calculateMatchPoints(final, pred) {
            if (!final || final.homeScore === undefined || !pred || pred.homeScore === undefined) return 0;
            if (final.homeScore == pred.homeScore && final.awayScore == pred.awayScore) return 3;
            const finalW = Math.sign(final.homeScore - final.awayScore);
            const predW = Math.sign(pred.homeScore - pred.awayScore);
            if (finalW === predW) return 1;
            if (final.homeScore == pred.awayScore && final.awayScore == pred.homeScore) return -1;
            return 0;
        }

        // --- CONFIGURAÇÃO DE EVENTOS ---
        function setupEventListeners() {
            ui.mainTabs.forEach(tab => tab.addEventListener('click', () => {
                ui.mainTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                loadStage(tab.dataset.stage);
            }));

            ui.groupTabs.forEach(tab => tab.addEventListener('click', () => {
                ui.groupTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                loadGroupData(tab.dataset.group);
            }));
        }
    </script>
</body>
</html>